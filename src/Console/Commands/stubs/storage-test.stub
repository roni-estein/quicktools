<?php

namespace DummyNamespace;

use App\User;
use Carbon\Carbon;
use Tests\DomainTestCase;
use Illuminate\Foundation\Testing\TestResponse;

// STORAGE TEST

class DummyClass extends DomainTestCase
{
    const TEST_ROUTE = 'example.store';

    ////////////////////// CONTROL TESTS //////////////////////

    /** @test */
    public function a_example_can_be_saved()
    {
        $this->submitFieldsNoExceptions()
        ->assertCreated();

        $this->assertDatabaseHas('examples', $this->storedFields());
    }

    ////////////////////// INVALID TESTS //////////////////////

    /** @test */
    public function a_field_is_required()
    {
        $this->submitFields(['field' => null])
            ->assertSessionHasErrors('field');
    }

    ////////////////////// FEATURE TESTS //////////////////////



    ////////////////////// TEST HELPERS //////////////////////

    public function setUp(): void
    {
        parent::setUp();
        $this->user = $this->basicSignIn(User::first());
    }

    protected function submitFieldsNoExceptions($attributes = []): TestResponse
    {
        return $this
            ->post(route(self::TEST_ROUTE, []), $this->getValidFields($attributes));
    }

    protected function submitFields($attributes = []): TestResponse
    {
        return $this
            ->withExceptionHandling()
            ->post(route(self::TEST_ROUTE, []), $this->getValidFields($attributes));
    }

    private function storedFields($overwrite = [])
    {
        $filteredKeys = [
            'user_id' => $this->user->id,
            'example_id' => $this->example->id,
            'notes' => null,
        ];

        return array_intersect_key($overwrite + $filteredKeys, $filteredKeys);
    }

    protected function getValidFields($attributes = []): array
    {
        //MAYBE FIELDS THAT GET SAVED TO A SESSION
        $baseArray = [
            'non_table_form_field' => true,
            'another_non_table_form_field' => '123 Fake St',
        ];

        return array_merge(
            $this->storedFields(),
            $baseArray,
            // $otherPossibleFieldSource, // or Example::getOptions(),
            $attributes
        );
    }
}
